<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="light">
  <head>
    <%- include('partials/head-meta') %>
  </head>
  <body class="layout-body">
    <!-- Loader -->
    <div id="loader" class="loader-overlay" aria-live="polite">
      <div class="mandala-spinner" role="status" aria-label="Loading page content"></div>
    </div>

    <%- include('partials/header') %>

    <main id="main" tabindex="-1" role="main">
      <%- body %>
    </main>

    <%- include('partials/footer') %>

    <!-- Supplementary Content -->
    <%- include('partials/dialogs') %>
    <%- include('partials/drawer') %>

    <!-- Floating Action Buttons -->
    <div class="fab-container" role="complementary" aria-label="Quick actions">
      <a class="fab-wa btn" href="https://wa.me/7990625845" target="_blank" rel="noopener" aria-label="Chat with Bharadwaj Ayurveda Clinic on WhatsApp" title="Chat on WhatsApp">
        <svg class="wa-ic" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M20.52 3.48A11.86 11.86 0 0 0 12.02 0C5.41 0 .06 5.35.06 11.96c0 2.11.55 4.14 1.6 5.95L0 24l6.27-1.64a12 12 0 0 0 5.75 1.46h.01c6.61 0 11.96-5.35 11.96-11.96a11.86 11.86 0 0 0-3.47-8.38ZM12.03 21.3h-.01a9.35 9.35 0 0 1-4.76-1.3l-.34-.2-3.72.97.99-3.62-.22-.37a9.3 9.3 0 0 1-1.4-4.88c0-5.16 4.2-9.36 9.37-9.36 2.5 0 4.85.97 6.62 2.74a9.33 9.33 0 0 1 2.74 6.62c0 5.17-4.2 9.36-9.37 9.36Zm5.42-6.99c-.3-.15-1.75-.86-2.02-.96-.27-.1-.46-.15-.66.15-.2.3-.76.95-.93 1.14-.17.2-.34.23-.64.08-.3-.15-1.26-.47-2.4-1.5-.89-.79-1.49-1.76-1.66-2.06-.17-.3-.02-.46.13-.61.14-.14.3-.35.45-.52.15-.17.2-.3.3-.5.1-.2.05-.38-.03-.53-.08-.15-.66-1.6-.9-2.2-.24-.58-.48-.5-.66-.5h-.56c-.2 0-.53.08-.82.38-.3.3-1.07 1.04-1.07 2.53s1.1 2.94 1.25 3.14c.15.2 2.16 3.3 5.23 4.62.73.31 1.3.49 1.75.63.74.24 1.4.2 1.92.12.59-.09 1.75-.72 2-1.41.25-.7.25-1.3.17-1.43-.07-.13-.27-.2-.57-.35Z"/></svg>
        <span class="sr-only">WhatsApp</span>
      </a>
      <a class="fab-cart" href="/cart" aria-label="View cart" title="View cart">
        <span class="fab-cart-emoji" aria-hidden="true">ðŸ›’</span>
        <span class="fab-cart-count" id="floating-cart-count" data-count="<%= typeof cartCount !== 'undefined' ? cartCount : 0 %>"><%= typeof cartCount !== 'undefined' ? cartCount : 0 %></span>
      </a>
    </div>

    <!-- Graceful Degradation -->
    <noscript>
      <div class="noscript-message" role="alert">
        <p>This website requires JavaScript to function properly. Please enable JavaScript in your browser settings for the best experience.</p>
        <p>You can still contact us directly at <a href="tel:+917990625845">079906 25845</a> or visit our clinic.</p>
      </div>
    </noscript>
    <script>
    // Floating cart count updater
    (function(){
      const badge = document.getElementById('floating-cart-count');
      if(!badge) return;
      function setCount(val){
        const n = Math.max(0, parseInt(val,10)||0);
        badge.textContent = n;
        badge.dataset.count = n;
        badge.classList.add('pulse');
        setTimeout(()=>badge.classList.remove('pulse'), 600);
      }
      // Listen for custom cart:add events (emitted after successful server response)
      document.addEventListener('cart:add', e=>{
        if(e.detail && typeof e.detail.count !== 'undefined') {
          setCount(e.detail.count);
        } else {
          // fallback incremental update if server did not send count
          setCount((parseInt(badge.dataset.count,10)||0)+ (e.detail && e.detail.qty ? e.detail.qty : 1));
        }
      });

      // Make floating cart visible sooner (after DOM ready) to avoid late appearance
      window.addEventListener('DOMContentLoaded', ()=>{
        const fab = document.querySelector('.fab-container');
        if(fab) fab.classList.add('fab-ready');
      });
    })();
    </script>
    <script>
    // Fly-to-cart animation on cart:add
    (function(){
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if(prefersReduced) return; // respect user preference
      const cart = document.querySelector('.fab-cart');
      if(!cart) return;
      function animateFly(originBtn){
        const cartRect = cart.getBoundingClientRect();
        const startRect = originBtn.getBoundingClientRect();
        const emojiChar = originBtn.dataset.flyemoji || 'ðŸ›’';
        const el = document.createElement('span');
        el.className = 'fly-to-cart-emoji';
        el.textContent = emojiChar;
        el.style.left = (startRect.left + startRect.width/2 - 12) + 'px';
        el.style.top = (startRect.top + startRect.height/2 - 12) + 'px';
        document.body.appendChild(el);
        const dx = cartRect.left + cartRect.width/2 - (startRect.left + startRect.width/2);
        const dy = cartRect.top + cartRect.height/2 - (startRect.top + startRect.height/2);
        // force reflow then transform
        requestAnimationFrame(()=>{
          el.style.transform = `translate(${dx}px, ${dy}px) scale(.35)`;
          el.style.opacity = '0.1';
        });
        setTimeout(()=>{ el.remove(); }, 820);
        // cart bounce
        cart.classList.add('bouncing');
        setTimeout(()=>cart.classList.remove('bouncing'), 720);
      }
      // Map product id to last clicked button for context
      const lastButtonById = new Map();
      document.addEventListener('click', e=>{
        const btn = e.target.closest && e.target.closest('.add-to-cart-btn');
        if(btn){ lastButtonById.set(btn.dataset.id, btn); }
      });
      document.addEventListener('cart:add', e=>{
        const id = e.detail && e.detail.id;
        if(!id) return;
        const btn = lastButtonById.get(id);
        if(btn) animateFly(btn);
      });
    })();
    </script>
  </body>
</html>